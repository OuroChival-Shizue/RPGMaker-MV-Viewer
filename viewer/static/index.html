<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPG Maker 攻略查看器</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="header">
  <h1>RPG Maker 攻略查看器</h1>

  <div class="game-switch">
    <label for="gameSelect">当前游戏</label>
    <select id="gameSelect"></select>
    <button id="manageGamesBtn" class="manage-btn" type="button">管理游戏库</button>
  </div>

  <div class="global-search">
    <input type="text" id="globalSearchInput" placeholder="全局搜索: 物品名 / 对话内容 / 事件指令...">
    <button id="globalSearchBtn" type="button">搜索</button>
  </div>

  <span class="info" id="statusBar">正在初始化...</span>
  <button id="encBtn" onclick="toggleEncyclopedia()" style="background:#6c5ce7;border:none;color:#fff;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:14px;margin-left:8px;">图鉴</button>
</div>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-header">地图列表</div>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="搜索地图名称或ID...">
    </div>
    <div class="tree-wrap" id="treeWrap"></div>
  </div>

  <div class="map-panel">
    <div class="map-toolbar">
      <span class="label">地图:</span>
      <span class="value" id="mapTitle">未选择</span>
      <span class="label">尺寸:</span>
      <span class="value" id="mapSize">-</span>
      <span class="label">背景:</span>
      <span class="value" id="mapBgState">-</span>
      <span class="label">缩放:</span>
      <button class="zoom-btn" onclick="zoom(-4)">−</button>
      <span class="value" id="zoomLevel">32</span>
      <button class="zoom-btn" onclick="zoom(4)">+</button>
      <button class="toggle-btn" id="passToggle" onclick="togglePassability()">通行度</button>
      <button class="export-btn" onclick="exportGuidePrompt()">导出文本</button>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#ffd43b"></div><span class="legend-text">$ 宝箱</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#74b9ff"></div><span class="legend-text">→ 传送</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#ff6b6b"></div><span class="legend-text">! 战斗</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#51cf66"></div><span class="legend-text">T 对话</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#636e72"></div><span class="legend-text">· 其他</span></div>
      </div>
    </div>
    <div class="map-canvas-wrap" id="canvasWrap">
      <canvas id="mapCanvas"></canvas>
    </div>
  </div>

  <div class="detail-panel">
    <div class="detail-header">
      <button class="back-btn" id="backBtn" onclick="goBack()">← 返回</button>
      <span>详细信息</span>
    </div>
    <div class="detail-content" id="detailContent">
      <div class="empty-state">
        <div class="icon">🗺</div>
        <div>请先选择游戏，然后从左侧地图开始浏览</div>
      </div>
    </div>
  </div>
</div>

<div id="encPanel" style="display:none;position:absolute;top:48px;left:0;right:0;bottom:0;background:var(--bg);z-index:100;overflow:hidden;flex-direction:column;">
  <div style="display:flex;gap:4px;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);">
    <button class="enc-tab active" data-tab="weapons" onclick="switchEncTab('weapons')">武器</button>
    <button class="enc-tab" data-tab="armors" onclick="switchEncTab('armors')">防具</button>
    <button class="enc-tab" data-tab="items" onclick="switchEncTab('items')">物品</button>
    <button class="enc-tab" data-tab="skills" onclick="switchEncTab('skills')">技能</button>
    <button class="enc-tab" data-tab="enemies" onclick="switchEncTab('enemies')">怪物</button>
    <button class="enc-tab" id="encRefreshBtn" type="button">刷新图鉴</button>
    <input type="text" id="encSearch" placeholder="搜索名称..." oninput="filterEnc()" style="margin-left:auto;padding:4px 10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px;width:200px;">
  </div>
  <div style="display:flex;flex:1;overflow:hidden;">
    <div id="encList" style="flex:1;overflow-y:auto;padding:8px;"></div>
    <div id="encDetail" style="width:400px;overflow-y:auto;padding:12px;border-left:1px solid var(--border);background:var(--panel);">
      <div style="color:var(--muted);">点击左侧条目查看详情</div>
    </div>
  </div>
</div>

<div id="gameModal" class="modal hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3>游戏库管理</h3>
      <button type="button" class="modal-close" id="closeGameModalBtn">关闭</button>
    </div>
    <div class="modal-body">
      <div class="quick-add">
        <input id="registerExeInput" type="text" placeholder="可选：输入 EXE 全路径并点右侧添加（推荐仍使用 add_game.bat 拖拽）">
        <button id="pickExeBtn" type="button">浏览选择</button>
        <button id="registerExeBtn" type="button">添加 EXE</button>
      </div>
      <div id="registryWarning" class="warn-text" style="display:none"></div>
      <div id="gameList" class="game-grid"></div>
    </div>
  </div>
</div>

<div id="loadingModal" class="loading-modal hidden">
  <div class="loading-card">
    <div class="loading-spinner"></div>
    <div class="loading-main">
      <div id="loadingText">正在加载...</div>
      <div class="loading-progress-track">
        <div id="loadingProgressBar" class="loading-progress-bar"></div>
      </div>
      <div id="loadingPercent" class="loading-percent">0%</div>
    </div>
  </div>
</div>

<div id="floatingWindowLayer" class="floating-window-layer"></div>

<script src="/app.js"></script>
</body>
</html>
