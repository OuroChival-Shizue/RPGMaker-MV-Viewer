/* ===== 全局重置与基础 ===== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f0f13; --bg2:#16161d; --bg3:#1e1e2a;
  --border:#2a2a3a; --text:#c8c8d8; --text2:#8888a0;
  --accent:#6c5ce7; --accent2:#a29bfe;
  --red:#ff6b6b; --green:#51cf66; --gold:#ffd43b;
  --blue:#74b9ff; --orange:#ffa94d;
  --panel:#16161d; --hover:#242437; --muted:#8888a0;
}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);
  color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
a{color:var(--accent2);text-decoration:none}

/* ===== 顶部标题栏 ===== */
.header{background:linear-gradient(135deg,#1a1a2e,#16213e);
  padding:10px 20px;display:flex;align-items:center;gap:16px;
  border-bottom:1px solid var(--border);flex-shrink:0}
.header h1{font-size:18px;font-weight:600;
  background:linear-gradient(135deg,var(--accent2),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header .info{font-size:12px;color:var(--text2)}
.global-search{display:flex;gap:6px;margin-left:auto;margin-right:12px}
.global-search input{width:280px;padding:5px 10px;border-radius:6px;border:1px solid var(--border);
  background:var(--bg3);color:var(--text);font-size:13px;outline:none;transition:.2s}
.global-search input:focus{border-color:var(--accent);width:340px}
.global-search button{padding:5px 14px;border-radius:6px;border:1px solid var(--accent);
  background:var(--accent);color:#fff;font-size:13px;cursor:pointer;white-space:nowrap}
.global-search button:hover{background:var(--accent2)}

/* ===== 三栏布局 ===== */
.main{display:flex;flex:1;overflow:hidden}

/* --- 左侧地图树 --- */
.sidebar{width:260px;min-width:200px;background:var(--bg2);
  border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;
  font-weight:600;color:var(--accent2);text-transform:uppercase;letter-spacing:1px}
.search-box{padding:8px 12px;border-bottom:1px solid var(--border)}
.search-box input{width:100%;padding:6px 10px;border-radius:6px;border:1px solid var(--border);
  background:var(--bg3);color:var(--text);font-size:13px;outline:none;transition:.2s}
.search-box input:focus{border-color:var(--accent)}
.tree-wrap{flex:1;overflow-y:auto;padding:6px 0}
.tree-wrap::-webkit-scrollbar{width:6px}
.tree-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* 树节点 */
.tree-node{user-select:none}
.tree-label{display:flex;align-items:center;padding:4px 8px;cursor:pointer;
  font-size:13px;border-radius:4px;margin:1px 6px;transition:.15s;gap:4px}
.tree-label:hover{background:var(--bg3)}
.tree-label.active{background:var(--accent);color:#fff}
.tree-label .arrow{width:16px;text-align:center;font-size:10px;color:var(--text2);
  transition:transform .2s;flex-shrink:0}
.tree-label .arrow.open{transform:rotate(90deg)}
.tree-label .arrow.empty{visibility:hidden}
.tree-label .id{color:var(--text2);font-size:11px;margin-right:4px;font-family:monospace}
.tree-children{padding-left:14px;display:none}
.tree-children.open{display:block}

/* --- 中间地图视图 --- */
.map-panel{flex:1;display:flex;flex-direction:column;min-width:0}
.map-toolbar{padding:8px 12px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;font-size:13px;background:var(--bg2)}
.map-toolbar .label{color:var(--text2)}
.map-toolbar .value{color:var(--accent2);font-weight:600}
.zoom-btn{padding:2px 10px;border-radius:4px;border:1px solid var(--border);
  background:var(--bg3);color:var(--text);cursor:pointer;font-size:14px}
.zoom-btn:hover{background:var(--accent);color:#fff}
.toggle-btn{padding:2px 10px;border-radius:4px;border:1px solid var(--border);
  background:var(--bg3);color:var(--text2);cursor:pointer;font-size:12px;transition:.15s}
.toggle-btn:hover{border-color:var(--accent)}
.toggle-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.export-btn{padding:2px 10px;border-radius:4px;border:1px solid var(--accent);
  background:var(--accent);color:#fff;cursor:pointer;font-size:12px;transition:.15s}
.export-btn:hover{background:var(--accent2);border-color:var(--accent2)}
.legend{display:flex;align-items:center;gap:10px;margin-left:auto;font-size:12px}
.legend-item{display:flex;align-items:center;gap:4px}
.legend-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
.legend-text{color:var(--text2)}
.map-canvas-wrap{flex:1;overflow:auto;position:relative;background:#0a0a10;cursor:grab}
.map-canvas-wrap.dragging{cursor:grabbing;user-select:none}
.map-canvas-wrap::-webkit-scrollbar{width:8px;height:8px}
.map-canvas-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
canvas{display:block}

/* --- 右侧详情面板 --- */
.detail-panel{width:360px;min-width:260px;background:var(--bg2);
  border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.detail-header{padding:10px 12px;border-bottom:1px solid var(--border);
  font-size:13px;font-weight:600;color:var(--accent2);display:flex;align-items:center;gap:8px}
.back-btn{padding:2px 8px;border-radius:4px;border:1px solid var(--border);
  background:var(--bg3);color:var(--text2);cursor:pointer;font-size:12px;transition:.15s;display:none}
.back-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.detail-content{flex:1;overflow-y:auto;padding:12px;font-size:13px;line-height:1.7}
.detail-content::-webkit-scrollbar{width:6px}
.detail-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* 详情面板内的样式 */
.info-block{margin-bottom:12px;padding:10px;background:var(--bg3);
  border-radius:8px;border:1px solid var(--border)}
.info-block h3{font-size:13px;color:var(--accent2);margin-bottom:6px;
  padding-bottom:4px;border-bottom:1px solid var(--border)}
.info-row{display:flex;gap:8px;padding:2px 0}
.info-key{color:var(--text2);min-width:60px}
.info-val{color:var(--text);font-weight:500}

/* 事件页标签 */
.page-tabs{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}
.page-tab{padding:4px 12px;border-radius:4px;border:1px solid var(--border);
  background:var(--bg);cursor:pointer;font-size:12px;color:var(--text2);transition:.15s}
.page-tab:hover{border-color:var(--accent)}
.page-tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* 指令行 */
.cmd-line{padding:2px 0;font-family:'Cascadia Code','Fira Code',monospace;font-size:12px}
.cmd-talk{color:#74b9ff}
.cmd-talk-text{color:#dfe6e9;padding-left:12px}
.cmd-choice{color:#ffd43b}
.cmd-choice-branch{color:#fab005}
.cmd-cond{color:#ff922b}
.cmd-switch{color:#a29bfe}
.cmd-var{color:#69db7c}
.cmd-gold{color:#ffd43b;font-weight:600}
.cmd-item{color:#51cf66;font-weight:600}
.cmd-transfer{color:#74b9ff;font-weight:600}
.cmd-battle{color:#ff6b6b}
.cmd-comment{color:#636e72;font-style:italic}
.cmd-script{color:#b2bec3}
.cmd-misc{color:#8888a0}
.cmd-unknown{color:#555}
.cmd-common-event{color:#e599f7;cursor:pointer;text-decoration:underline;text-decoration-style:dotted}
.cmd-common-event:hover{color:#f0abfc}
.ref-link{color:inherit;cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px}
.ref-link:hover{color:var(--accent2)}
.battle-badge{display:inline-block;margin-left:6px;padding:0 6px;border-radius:10px;
  font-size:10px;background:#ffd43b;color:#2f2f2f;vertical-align:1px}
.item-tip-title{font-weight:600;color:var(--accent2);margin-bottom:4px}
.item-tip-kind{color:var(--text2);font-size:11px;margin-left:6px}
.item-tip-badge{display:inline-block;margin-left:6px;padding:1px 6px;border-radius:10px;
  font-size:10px;background:#ffd43b;color:#2f2f2f}
.item-tip-desc{color:var(--text2);margin:4px 0 6px;white-space:pre-wrap}
.item-tip-row{display:flex;justify-content:space-between;gap:8px;padding:2px 0;border-bottom:1px solid var(--border)}
.item-tip-row .val{color:var(--accent2);font-weight:600}
.item-tip-section{margin-top:6px;padding-top:6px;border-top:1px solid var(--border)}
.item-tip-section-title{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.item-tip-list div{margin:2px 0}
.item-tip-portrait{width:100%;max-height:240px;object-fit:contain;background:#10131d;border:1px solid var(--border);border-radius:8px;margin-bottom:8px}
.item-tip-portrait-empty{padding:10px;border:1px dashed var(--border);border-radius:8px;color:var(--text2);margin-bottom:8px;text-align:center}

/* 事件列表 */
.evt-list-item{display:flex;align-items:center;gap:8px;padding:5px 8px;
  border-radius:4px;cursor:pointer;transition:.15s;font-size:12px}
.evt-list-item:hover{background:var(--bg3)}
.evt-list-item .dot{width:8px;height:8px;border-radius:50%;background:var(--red);flex-shrink:0}
.evt-list-item .eid{color:var(--text2);font-family:monospace}
.evt-list-item .ename{color:var(--text)}
.evt-list-item .epos{color:var(--text2);margin-left:auto;font-family:monospace}

/* 搜索结果 */
.search-result{padding:8px 10px;border-radius:6px;border:1px solid var(--border);
  background:var(--bg);margin-bottom:6px;cursor:pointer;transition:.15s}
.search-result:hover{border-color:var(--accent);background:var(--bg3)}
.sr-header{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.sr-map{color:var(--accent2);font-weight:600;font-size:12px}
.sr-evt{color:var(--text);font-size:12px}
.sr-pos{color:var(--text2);font-size:11px;font-family:monospace;margin-left:auto}
.sr-match{color:var(--text2);font-size:11px;padding-left:8px;
  border-left:2px solid var(--border);margin-top:2px;line-height:1.5}

/* 空状态 */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;color:var(--text2);gap:8px;font-size:14px}
.empty-state .icon{font-size:48px;opacity:.3}

/* 图鉴 */
.enc-tab{background:var(--bg);color:var(--text2);border:1px solid var(--border);
  padding:5px 14px;border-radius:4px;cursor:pointer;font-size:13px}
.enc-tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.enc-item{padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;
  justify-content:space-between;align-items:center;margin-bottom:2px;font-size:13px}
.enc-item:hover{background:var(--hover)}
.enc-item.sel{background:var(--accent);color:#fff}
.enc-item .eid{color:var(--text2);font-size:11px;font-family:monospace}
.enc-item .price{color:#ffd43b;font-size:11px}
.enc-detail h3{margin:0 0 8px;color:var(--accent2);font-size:16px}
.enc-detail .desc{color:var(--text2);font-size:12px;margin-bottom:10px;line-height:1.6;
  white-space:pre-wrap}
.enc-detail .stat{display:flex;justify-content:space-between;padding:3px 0;
  font-size:12px;border-bottom:1px solid var(--border)}
.enc-detail .stat .val{color:var(--accent2);font-weight:600}
.enc-detail .trait{font-size:12px;color:var(--text);padding:2px 0}
.enc-detail .section{margin-top:10px;padding-top:8px;border-top:1px solid var(--border)}
.enc-detail .section-title{font-size:11px;color:var(--text2);text-transform:uppercase;
  margin-bottom:4px;letter-spacing:1px}
.formula-raw{font-family:'Cascadia Code','Fira Code',monospace;font-size:12px;line-height:1.5;
  background:#11152a;border:1px solid var(--border);border-radius:6px;padding:8px;word-break:break-all}
.formula-pretty{margin-top:6px;font-size:12px;color:var(--accent2);line-height:1.6;white-space:pre-wrap}
.enc-item-main{display:flex;align-items:center;gap:8px;min-width:0}
.enc-item-main .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pixel-icon{display:inline-block;flex-shrink:0;width:24px;height:24px;border-radius:4px;background:#0d111c;border:1px solid var(--border);image-rendering:pixelated;background-repeat:no-repeat}
.pixel-icon.skeleton{background:linear-gradient(110deg,#1a2030 8%,#2a344e 18%,#1a2030 33%);background-size:200% 100%;animation:iconPulse 1.1s linear infinite;border-color:#303b56}
.pixel-icon.empty{opacity:.45}
@keyframes iconPulse{to{background-position-x:-200%}}
.event-visuals{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.event-visual{display:flex;flex-direction:column;gap:4px;min-width:84px}
.event-visual .label{font-size:11px;color:var(--text2)}
.event-visual-img{width:72px;height:72px;object-fit:contain;border:1px solid var(--border);border-radius:6px;background:#11152a;image-rendering:pixelated}
.event-visual-canvas{display:block}
.event-visual-fallback{font-size:11px;color:var(--text2)}

.fold-block{margin-bottom:10px;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px}
.fold-head{display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--accent2);font-size:13px;font-weight:600}
.fold-head .caret{transition:transform .15s}
.fold-head.collapsed .caret{transform:rotate(-90deg)}
.fold-body{margin-top:8px}
.fold-body.collapsed{display:none}
.cmd-scroll{max-height:340px;overflow:auto;padding-right:4px}
.cmd-scroll::-webkit-scrollbar{width:6px}
.cmd-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* ===== 游戏库管理 ===== */
.game-switch{display:flex;align-items:center;gap:8px}
.game-switch label{font-size:12px;color:var(--text2)}
.game-switch select{min-width:240px;max-width:340px;padding:5px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:12px}
.manage-btn{padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text);cursor:pointer;font-size:12px}
.manage-btn:hover{border-color:var(--accent)}
.no-game{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;gap:10px;color:var(--text2);text-align:center;padding:30px}

.modal{position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px}
.modal.hidden{display:none}
.modal-card{width:min(1080px,96vw);max-height:90vh;background:var(--bg2);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;overflow:hidden}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
.modal-head h3{margin:0;color:var(--accent2);font-size:15px}
.modal-close{padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);cursor:pointer}
.modal-close:hover{border-color:var(--accent);color:var(--text)}
.modal-body{display:flex;flex-direction:column;gap:12px;padding:12px;overflow:auto}
.quick-add{display:flex;gap:8px;align-items:center}
.quick-add input{flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg3);color:var(--text)}
.quick-add button{padding:8px 12px;border-radius:6px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer}
.quick-add button:hover{background:var(--accent2)}
.game-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:10px}
.game-card{border:1px solid var(--border);border-radius:8px;background:var(--bg3);overflow:hidden;display:flex;flex-direction:column}
.game-card.unavailable{opacity:.75;border-color:#6b4f4f}
.game-cover{height:140px;background:#111 no-repeat center/cover;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:12px}
.game-meta{padding:10px;display:flex;flex-direction:column;gap:6px}
.game-title{font-weight:600;color:var(--text)}
.game-path{font-size:11px;color:var(--text2);line-height:1.4;word-break:break-all}
.game-actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.game-actions button{padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:var(--bg2);color:var(--text2);font-size:12px;cursor:pointer}
.game-actions button:hover{border-color:var(--accent);color:var(--text)}
.game-actions .danger{border-color:#5a2f2f;color:#f08c8c}
.game-actions .primary{border-color:var(--accent);color:var(--accent2)}
.warn-text{font-size:12px;color:#ffa94d}

.loading-modal{position:fixed;inset:0;z-index:6000;background:rgba(5,6,10,.55);display:flex;align-items:center;justify-content:center}
.loading-modal.hidden{display:none}
.loading-card{min-width:320px;max-width:86vw;padding:18px 20px;border-radius:10px;border:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:12px;color:var(--text)}
.loading-spinner{width:18px;height:18px;border-radius:50%;border:2px solid #3a3a55;border-top-color:var(--accent2);animation:spin 0.9s linear infinite;flex-shrink:0}
.loading-main{display:flex;flex-direction:column;gap:8px;min-width:220px}
.loading-progress-track{height:8px;border:1px solid var(--border);border-radius:999px;background:#121625;overflow:hidden}
.loading-progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .25s ease}
.loading-percent{font-size:12px;color:var(--text2);text-align:right;line-height:1}

@keyframes spin{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

.floating-window-layer{position:fixed;inset:0;z-index:5500;pointer-events:none}
.floating-detail{position:fixed;left:80px;top:120px;width:min(540px,88vw);max-height:min(76vh,760px);display:flex;flex-direction:column;border:1px solid var(--border);border-radius:10px;background:var(--bg2);box-shadow:0 16px 40px rgba(0,0,0,.45);pointer-events:auto}
.floating-detail.dragging{cursor:grabbing;user-select:none}
.floating-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);cursor:grab}
.floating-header span{color:var(--accent2);font-weight:600}
.floating-header button{padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text);cursor:pointer}
.floating-header button:hover{border-color:var(--accent);color:var(--accent2)}
.floating-body{padding:10px 12px;overflow:auto;font-size:12px;line-height:1.55}
.floating-body::-webkit-scrollbar{width:6px}
.floating-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.inline-ref-panel{margin-top:10px}

@media (max-width: 1024px) {
  .header{flex-wrap:wrap;align-items:flex-start;gap:8px}
  .global-search{order:3;width:100%;margin:0}
  .global-search input{width:100%}
  .global-search input:focus{width:100%}
  .game-switch select{min-width:180px;max-width:100%}
}
